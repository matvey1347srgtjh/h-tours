{% extends "base.html" %}
{% load static %}

{% block content %}

<main class="profile-container">
    <div class="profile-grid">
        <div class="profile-info">
            <h2>Личная информация</h2>
            <div class="profile-avatar">
                {% if avatar.avatar %}
                    <img src="{{ avatar.avatar.url }}" alt="Аватар пользователя">
                {% else %}
                    <img src="{% static 'images/anonymous.png' %}" alt="Аватар пользователя">
                {% endif %}
                <form method="post" enctype="multipart/form-data" class="avatar-form">
                    {% csrf_token %}
                    <input type="file" name="avatar" class="inp-file" accept="image/*">
                    <button type="submit" class="btn" style="display: block; margin: 10px auto;">Изменить фото</button>
                </form>
                <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="button2">Выйти</button>
                </form>
                {% if user.is_superuser %}
    <div class="admin-link">
        <a href="{% url 'admin:index' %}" style="text-decoration:none"><button class="btn" style="display: block; margin: 30px auto;">Админ панель</button></a>
    </div>
{% endif %}
            </div>
            <form method="post" class="profile-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="name">Имя:</label>
                    <input type="text" id="name" name="username" value="{{ user.username }}">
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" value="{{ user.email }}">
                </div>
                
                <button type="submit" class="btn">Сохранить изменения</button>
            </form>
        </div>

        <div class="profile-bookings">
            <h2>Мои бронирования</h2><br>
            {% if orders %}
            <div class="df">
                {% for order in orders %}
                <div class="card-2">
                    <div class="tour-card">
                        <p>ID заказа: {{ order.id }}</p>
                        <p>Статус: {{ order.get_status_display }}</p>
                        <p>Дата заказа: {{ order.order_date }}</p>
                        <p>Дата начала: {{ order.start_date }}</p>
                        <p>Дата окончания: {{ order.end_date }}</p>
            
                        {% for item in order.items.all %}
                            <p>Тур: {{ item.jew.name |safe}}</p>
                            <p>Город: {{ item.jew.city }}</p>
                            <p>Кол-во дней: {{ item.jew.days }}</p>
                            <p>Кол-во людей: {{ item.quantity}}</p>
            
                            <div class="jewelry-item">
                                <a href="{% url 'jew_detail' item.jew.id %}">
                                    <img src="{{ item.jew.image.url }}" alt="{{ item.jew.name }}" class="img-hover" width="30%">
                                </a>
                                <p>{{ item.jew.price }} $</p>
                                
                                {% if not item.jew.id in favorite_ids %}
                                    <form action="{% url 'add_to_favorites' item.jew.id %}" method="post">
                                        {% csrf_token %}
                                        <button type="submit" class="feath-button">Добавить в избранное</button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endfor %}
            
                        {% if order.status == 'COMPLETED' %}
                        {% if not order.review %}
                        <br>
                            <a href="{% url 'leave_review' order.id %}" class="btn">Оставить отзыв</a>
                            <br>
                        {% else %}
                            <p>Ваш отзыв: {{ order.review.comment }}</p>
                            <div class="star-rating-1">
                                {% for i in "12345" %}
                                    {% if i <= order.review.rating|stringformat:"i" %}
                                        <span class="filled">★</span>  
                                    {% else %}
                                        <span>☆</span>  
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                    </div>
                </div>
                <br><br>
            {% endfor %}
            </div>
            {% else %}
                <p>У вас нет бронирований.</p>
            {% endif %}
        </div>

        <div class="profile-wishlist">
            <h2>Избранные туры</h2>
            <br>
            {% if favorites %}
            <div class="df">
                {% for favorite in favorites %}
                    <div class="card-2">
                        <div class="tour-card">
                            <p>{{ favorite.jewelry.name |safe }}</p>
                            <div class="jewelry-item">
                                <a href="{% url 'jew_detail' favorite.jewelry.id %}">
                                    <img src="{{ favorite.jewelry.image.url }}" alt="{{ favorite.jewelry.name }}" class="img-hover" width="30%">
                                </a>
                                <p>{{ favorite.jewelry.price }} $</p>
                                
                                
                            </div>
                            <br>
                        </div>
                    </div>
                    <br><br>
                {% endfor %}
            </div>
            {% else %}
                <p>У вас нет избранных туров.</p>
            {% endif %}
        </div>
    </div>
</main>

{% endblock %}